<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Excellence: RA11032 Citizen's Charter</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #003399; /* DOTr Blue */
            --accent: #d4af37; /* Gold/Bagong Pilipinas accent */
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --text: #333;
            --ai-color: #10a37f; /* AI Green */
            --success: #28a745;
            --error: #dc3545;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); line-height: 1.6; }

        /* --- Header --- */
        header {
            background: linear-gradient(90deg, #ffffff 0%, #f8f9fa 100%);
            padding: 1rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary);
            position: sticky; top: 0; z-index: 1000;
        }
        .header-logos { display: flex; gap: 20px; align-items: center; }
        .logo-img { height: 60px; width: auto; transition: transform 0.3s; }
        .logo-img:hover { transform: scale(1.05); }
        .header-text h1 { color: var(--primary); margin: 0; font-size: 1.5rem; text-transform: uppercase; }
        .header-text small { color: #666; font-weight: 600; }

        /* --- Layout --- */
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 20px; }
        .card {
            background: var(--card-bg); border-radius: 12px; padding: 2.5rem;
            margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            animation: fadeIn 0.5s ease-in-out; position: relative;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        h3 { margin-top: 2rem; color: #444; }

        /* --- UI Elements --- */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.3s;
            font-size: 1rem; box-shadow: 0 4px 6px rgba(0,51,153,0.2);
        }
        .btn:hover { background: #002266; transform: translateY(-2px); }
        
        input[type="text"], input[type="tel"], select, textarea, input[type="password"] { 
            width: 100%; padding: 12px; margin: 8px 0 20px 0; 
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; 
            font-family: inherit; font-size: 1rem;
        }
        
        .instruction-box {
            background: #e8f0fe; border-left: 5px solid var(--primary);
            padding: 15px; margin-bottom: 20px; border-radius: 4px; color: #333;
        }

        /* --- Quiz Styling --- */
        .quiz-item { background: #fafafa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .quiz-option-row { 
            display: flex; align-items: flex-start; padding: 12px; margin: 8px 0; 
            background: white; border: 1px solid #ddd; border-radius: 6px; 
            cursor: pointer; transition: 0.2s; 
        }
        .quiz-option-row:hover { background: #f0f4ff; border-color: var(--primary); }
        .quiz-option-row input[type="radio"] { 
            margin-right: 15px; margin-top: 4px; transform: scale(1.2); 
            width: auto !important;
        }
        
        /* --- Video Container --- */
        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin: 20px 0;
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* --- AI Assistant Chatbot --- */
        #ai-fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--ai-color); color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 2000;
            transition: transform 0.3s;
        }
        #ai-fab:hover { transform: scale(1.1); }
        
        #ai-chat-window {
            position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px;
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none; flex-direction: column; z-index: 2000; overflow: hidden;
            border: 1px solid #ddd;
        }
        .chat-header { background: var(--ai-color); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; }
        .chat-msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; max-width: 80%; }
        .bot-msg { background: #e0e0e0; color: #333; align-self: flex-start; }
        .user-msg { background: var(--ai-color); color: white; align-self: flex-end; margin-left: auto; }
        
        /* --- AI Evaluation Badge --- */
        .ai-badge { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-left: 10px; }
        .ai-high { background: #d4edda; color: #155724; }
        .ai-med { background: #fff3cd; color: #856404; }
        .ai-low { background: #f8d7da; color: #721c24; }

        /* --- Admin Dashboard --- */
        #admin-panel { display: none; }
        .admin-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .data-table th { background: var(--primary); color: white; }

        /* --- Certificate --- */
        #certificate-view { display: none; text-align: center; border: 15px solid var(--primary); padding: 40px; background: #fff; }
    </style>
</head>
<body>

<div id="ai-fab" onclick="toggleChat()">
    <i class="fas fa-robot fa-2x"></i>
</div>

<div id="ai-chat-window">
    <div class="chat-header">
        <span><i class="fas fa-brain"></i> DOTr AI Assistant</span>
        <i class="fas fa-times" style="cursor:pointer" onclick="toggleChat()"></i>
    </div>
    <div class="chat-body" id="chat-body">
        <div class="chat-msg bot-msg">Hello! I am your AI learning companion. Ask me anything about RA 11032 or the Citizen's Charter!</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type a question..." style="margin:0">
        <button class="btn" style="padding: 10px 15px; margin:0; border-radius: 4px;" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="login-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000;">
    <div style="background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center;">
        <h2 style="border:none">Admin Login</h2>
        <input type="password" id="admin-pass" placeholder="Enter Password">
        <button class="btn" onclick="verifyAdmin()" style="width:100%; margin-bottom:10px;">Login</button>
        <button class="btn" style="background:#dc3545; width:100%" onclick="document.getElementById('login-modal').style.display='none'">Cancel</button>
    </div>
</div>

<header>
    <div class="header-logos">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Department_of_Transportation_%28Philippines%29.svg/1200px-Department_of_Transportation_%28Philippines%29.svg.png" alt="DOTr" class="logo-img">
        <div class="header-text">
            <h1>Service Excellence</h1>
            <small>A Guide to RA11032 Citizen's Charter</small>
        </div>
    </div>
    <div style="text-align: right;">
        <img src="https://bagongpilipinasmediahub.ph/wp-content/uploads/2023/12/bagong-pilipinas-logo.png" alt="Bagong Pilipinas" class="logo-img">
        <br>
        <a onclick="document.getElementById('login-modal').style.display='flex'" style="cursor:pointer; font-size:0.8rem; color:#999; text-decoration:none;"><i class="fas fa-lock"></i> Admin</a>
    </div>
</header>

<div class="container" id="app">
    <div class="card" style="text-align:center">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
        <p>Loading Offline Course Content...</p>
    </div>
</div>

<div class="container" id="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard (Offline)</h2>
        <button class="btn" style="background:#dc3545" onclick="location.reload()">Logout</button>
    </div>
    <div class="instruction-box">Note: Since this is offline mode, data resets when you refresh the page.</div>
    <div class="admin-dashboard">
        <div class="stat-card">
            <div class="stat-number" id="total-trainees">0</div>
            <div>Registered Trainees</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avg-engagement">0%</div>
            <div>Avg. AI Engagement Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completion-rate">0%</div>
            <div>Completion Rate</div>
        </div>
    </div>
    <h3>Trainee Progress</h3>
    <div class="card" style="overflow-x:auto; padding:0;">
        <table class="data-table" id="admin-table">
            <thead>
                <tr>
                    <th>Trainee</th>
                    <th>Pre-Test</th>
                    <th>Post-Test</th>
                    <th>AI Engagement</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // --- OFFLINE MOCK DATABASE ---
    // This replaces Firebase so you can run it locally without errors.
    const mockDB = {
        logs: [],
        add: function(data) {
            const id = 'OFFLINE-' + Math.floor(Math.random() * 10000);
            this.logs.push({ id: id, ...data });
            console.log("Mock DB Save:", data);
            return Promise.resolve({ id: id });
        },
        update: function(id, data) {
            const index = this.logs.findIndex(l => l.id === id);
            if (index !== -1) {
                this.logs[index] = { ...this.logs[index], ...data };
                console.log("Mock DB Update:", this.logs[index]);
            }
            return Promise.resolve();
        },
        getAll: function() {
            return Promise.resolve(this.logs);
        }
    };

    // --- AI PROCTORING LOGIC ---
    let aiProctor = {
        focusLostCount: 0,
        startTime: Date.now(),
        interactions: 0,
        getEngagementScore: function() {
            let score = 100 - (this.focusLostCount * 5); 
            if (this.interactions > 50) score += 5;
            return Math.max(0, Math.min(100, score));
        }
    };
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            aiProctor.focusLostCount++;
            console.log("AI Proctor: User left tab.");
        }
    });
    document.addEventListener("click", () => aiProctor.interactions++);

    // --- AI CHATBOT LOGIC ---
    const knowledgeBase = {
        "ra 11032": "Republic Act No. 11032 is the Ease of Doing Business and Efficient Government Service Delivery Act of 2018.",
        "citizen": "A Citizen's Charter is an official document that details services, requirements, fees, and processing times.",
        "charter": "The Citizen's Charter is a public document communicating the agency's service standards.",
        "3-7-20": "Processing times: 3 days for simple, 7 days for complex, and 20 days for highly technical transactions.",
        "fixing": "Fixing is facilitating transactions for gain/advantage and is strictly prohibited.",
        "contact": "You can contact ARTA or the Presidential Complaints Center (8888).",
        "pass": "You need 75% for module quizzes and 90% for the post-test.",
        "hello": "Hello! I am your AI learning assistant. Ask me about the course topics!",
        "time": "Processing times are strictly regulated: 3, 7, or 20 working days.",
        "fee": "Fees must be clearly stated in the Citizen's Charter."
    };

    function toggleChat() {
        const win = document.getElementById('ai-chat-window');
        win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.toLowerCase().trim();
        if (!text) return;
        addMsg(input.value, 'user-msg');
        input.value = '';
        setTimeout(() => {
            let response = "I'm analyzing your query... Try asking about 'RA 11032', 'Processing Time', or 'Citizen's Charter'.";
            for (let key in knowledgeBase) {
                if (text.includes(key)) { response = knowledgeBase[key]; break; }
            }
            addMsg(response, 'bot-msg');
        }, 600);
    }

    function addMsg(text, className) {
        const div = document.createElement('div');
        div.className = `chat-msg ${className}`;
        div.innerText = text;
        const body = document.getElementById('chat-body');
        body.appendChild(div);
        body.scrollTop = body.scrollHeight;
    }

    // --- COURSE DATA ---
    const courseData = {
        intro: `
            <h2>INTRODUCTION</h2>
            <p>The proper preparation of a Citizen’s Charter, as mandated by Republic Act No. 11032 (Ease of Doing Business and Efficient Government Service Delivery Act of 2018), ensures transparency, efficiency, and accountability in government transactions. It serves as a public document that clearly communicates the agency’s services, requirements, procedures, processing times, and feedback mechanisms. By adhering to RA 11032 guidelines, agencies reduce red tape, improve service delivery, and strengthen public trust.</p>
            <h3>OBJECTIVES</h3>
            <ol>
                <li><strong>Understand the Legal Basis</strong><br>Briefly explains the provisions of RA 11032 and its relevance to the Citizen’s Charter.</li>
                <li><strong>Learn the Key Components</strong><br>Identify the essential elements of a Citizen’s Charter, including service standards, requirements, and feedback mechanisms.</li>
                <li><strong>Master the Five Core Modules</strong><br>Guide participants through the structured modules of this course:
                    <ul><li>What is a Citizen’s Charter</li><li>Designing the Initial Sections</li><li>Organizing the Service Specifications</li><li>Feedback and Complaints Mechanisms</li><li>List of Offices: How to Include Them</li></ul>
                </li>
                <li><strong>Develop Practical Skills</strong><br>Equip participants with the ability to draft, review, and update a Citizen’s Charter in compliance with RA 11032.</li>
            </ol>
            <div class="video-container" style="background:#000; display:flex; align-items:center; justify-content:center; color:white;">
                <div>[Video Placeholder: Introduction to RA 11032]</div>
            </div>
        `,
        modules: [
            {
                title: "MODULE 1: WHAT IS A CITIZEN’S CHARTER?",
                desc: "This module introduces the concept of the Citizen’s Charter as an official document and service standard mandated by Republic Act No. 11032.",
                video: "VIDEO_ID_1",
                quiz: [
                    { q: "What is the primary goal of RA 11032?", options: ["A. To increase government revenue.", "B. To streamline government services by reducing bureaucratic red tape.", "C. To mandate all citizens to register.", "D. To provide subsidies."], ans: 1 },
                    { q: "Which agency oversees RA 11032?", options: ["A. Anti-Red Tape Authority (ARTA).", "B. Civil Service Commission (CSC).", "C. Both A and B.", "D. Neither."], ans: 0 },
                    { q: "Max processing time for 'simple transactions'?", options: ["A. 7 days.", "B. 5 days.", "C. 3 days.", "D. 2 days."], ans: 2 },
                    { q: "Penalty for first offense of 'fixing'?", options: ["A. Suspension.", "B. Dismissal.", "C. Perpetual disqualification.", "D. Both B and C."], ans: 3 },
                    { q: "How are agencies mandated to publish their Charter?", options: ["A. Billboards.", "B. Websites/Digital.", "C. Both A and B.", "D. Neither."], ans: 2 }
                ]
            },
            {
                title: "MODULE 2: DESIGNING THE INITIAL SECTIONS",
                desc: "This module focuses on the foundational elements of the Citizen’s Charter Handbook, including the cover page and agency profile.",
                video: "VIDEO_ID_2",
                quiz: [
                    { q: "Core purpose of Citizen’s Charter?", options: ["A. Binding fee document.", "B. Employee list.", "C. Transparent service pact.", "D. Marketing tool."], ans: 2 },
                    { q: "Required info in Charter?", options: ["A. Procedures, docs, fees, responsible person.", "B. Internal policies.", "C. Agency history.", "D. Both A and C."], ans: 0 },
                    { q: "NOT a mandatory requirement?", options: ["A. Max time.", "B. Feedback procedure.", "C. Home addresses of staff.", "D. Fees."], ans: 2 },
                    { q: "Update frequency for Charter?", options: ["A. Every 5 years.", "B. Every 3 years or upon new service.", "C. Only with new admin.", "D. Never."], ans: 1 },
                    { q: "How to communicate Charter?", options: ["A. Official Gazette only.", "B. Simple language, visible areas.", "C. Written request only.", "D. Digital screens only."], ans: 1 }
                ]
            },
            // Note: I kept the structure but shortened the list for the Demo to ensure it fits. 
            // In a real deployment, you would include all modules here.
            {
                title: "MODULE 3: ORGANIZING SERVICE SPECIFICATIONS",
                desc: "This module explains how to structure the Service Specifications section (Fees, Time, Steps).",
                video: "VIDEO_ID_3",
                quiz: [
                    { q: "Max time for 'Complex Transactions'?", options: ["A. 5 days.", "B. 7 days.", "C. 10 days.", "D. 20 days."], ans: 1 },
                    { q: "Max time for 'Highly Technical'?", options: ["A. 15 days.", "B. 20 days.", "C. 30 days.", "D. 45 days."], ans: 1 },
                    { q: "Service standard requirements?", options: ["A. Employee ratings.", "B. Steps, docs, fees, officer.", "C. History.", "D. A and B."], ans: 1 },
                    { q: "Three types of transactions?", options: ["A. Easy/Medium/Hard.", "B. Simple/Complex/Technical.", "C. Fast/Slow/Normal.", "D. Basic/Advanced/Expert."], ans: 1 },
                    { q: "Consequence for failure (1st offense)?", options: ["A. Dismissal.", "B. Warning.", "C. 6 months suspension.", "D. Reassignment."], ans: 2 }
                ]
            }
        ]
    };

    let userState = { info: {}, docId: null, pretest_part2_answers: [] };
    const app = document.getElementById('app');

    // --- VIEW RENDER FUNCTIONS ---

    function renderAttendance() {
        app.innerHTML = `
            <div class="card">
                <h2>Attendance Form</h2>
                <div class="instruction-box">Kindly provide your full name in the following format: FIRST NAME, MIDDLE INITIAL, and LAST NAME.</div>
                <form id="attForm">
                    <label>Training/Course Title:</label>
                    <input type="text" value="Service Excellence: A Guide to RA11032 Citizen's Charter" readonly style="background:#f0f0f0;">
                    
                    <label>Full Name:</label>
                    <input type="text" id="fname" required placeholder="JUAN A. DELA CRUZ">
                    
                    <label>Gender (GEDSI):</label>
                    <select id="gender" required>
                        <option value="">Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Non-binary">Non-binary</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                    
                    <label>Type of Employment:</label>
                    <select id="emp" required>
                        <option value="">Select...</option>
                        <option value="Permanent">Permanent</option>
                        <option value="Co-terminus">Co-terminus</option>
                        <option value="Contractual">Contractual</option>
                        <option value="Contract of Service">Contract of Service</option>
                        <option value="Job Order">Job Order</option>
                    </select>
                    
                    <label>Position:</label><input type="text" id="pos" required>
                    <label>Office/Division:</label><input type="text" id="off" required>
                    <label>Complete ID Number:</label><input type="text" id="idn" required>
                    <label>Mobile Number:</label><input type="tel" id="mob" required>
                    
                    <button type="submit" class="btn">Start AI-Monitored Session</button>
                </form>
            </div>
        `;
        
        document.getElementById('attForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const info = {
                name: document.getElementById('fname').value.toUpperCase(),
                gender: document.getElementById('gender').value,
                employment: document.getElementById('emp').value,
                position: document.getElementById('pos').value,
                office: document.getElementById('off').value,
                id_num: document.getElementById('idn').value,
                mobile: document.getElementById('mob').value,
                timestamp: new Date().toISOString(),
                status: 'Started',
                ai_engagement: 100
            };
            
            // USE MOCK DB INSTEAD OF FIREBASE
            mockDB.add(info).then(docRef => {
                userState.docId = docRef.id;
                userState.info = info;
                renderIntro();
            });
        });
    }

    function renderIntro() {
        app.innerHTML = `
            <div class="card">
                ${courseData.intro}
                <div style="margin-top:20px; padding:15px; background:#e8f0fe; border-radius:8px; border:1px solid #c2d7fa;">
                    <strong><i class="fas fa-robot"></i> AI Proctor Active:</strong> 
                    Your engagement is being monitored to ensure training integrity. Please keep this tab active.
                </div>
                <button class="btn" style="margin-top:20px;" onclick="renderPretest()">Proceed to Pre-Test</button>
            </div>
        `;
    }

    function renderPretest() {
        app.innerHTML = `
            <div class="card">
                <h2>Pre-Test</h2>
                <div class="instruction-box">
                    <strong>General Instructions:</strong> This is a diagnostic test.
                </div>
                
                <h3>Test I. Matching Type (5 pts)</h3>
                ${['Service Standards', 'Vision/Mission', 'Redress Mechanism', 'Checklist of Requirements', 'Flowchart'].map((item, i) => `
                    <div class="quiz-item">
                        <label><strong>${i+1}. ${item}</strong></label>
                        <select id="pt1-${i}" style="margin-top:5px;"><option value="">Select...</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select>
                    </div>
                `).join('')}

                <h3>Test II. True or False (5 pts)</h3>
                ${[1,2,3,4,5].map(i => `
                    <div class="quiz-item" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>Statement ${i}</span>
                        <select id="pt2-${i-1}" style="width:100px; margin:0;"><option value="">Select...</option><option value="T">T</option><option value="F">F</option></select>
                    </div>
                `).join('')}
                
                <button class="btn" onclick="submitPretest()">Submit Pre-Test</button>
            </div>
        `;
    }

    function submitPretest() {
        for(let i=0; i<5; i++) userState.pretest_part2_answers.push(document.getElementById(`pt2-${i}`).value);
        
        let score = 0;
        const p1Key = ['C','D','A','B','E']; 
        const p2Key = ['F','T','F','T','F'];
        
        for(let i=0; i<5; i++) if(document.getElementById(`pt1-${i}`).value === p1Key[i]) score++;
        for(let i=0; i<5; i++) if(document.getElementById(`pt2-${i}`).value === p2Key[i]) score++;
        
        if(userState.docId) {
            mockDB.update(userState.docId, { pretest_score: score });
        }
        
        alert(`Pre-Test Submitted. Score: ${score}/10. Proceeding to Module 1.`);
        renderModule(0);
    }

    function renderModule(idx) {
        if(idx >= courseData.modules.length) { renderPosttest(); return; }
        const mod = courseData.modules[idx];
        
        app.innerHTML = `
            <div class="card">
                <h2>${mod.title}</h2>
                <div class="video-container" style="background:#000; display:flex; justify-content:center; align-items:center; color:white;">
                    [Video Placeholder: ${mod.title}]
                </div>
                <p>${mod.desc}</p>
                <hr>
                <h3>Module Quiz</h3>
                <div id="quiz-area">
                    ${mod.quiz.map((q,i) => `
                        <div class="quiz-item">
                            <p><strong>${i+1}. ${q.q}</strong></p>
                            ${q.options.map((o,oi) => `
                                <label class="quiz-option-row">
                                    <input type="radio" name="mq-${i}" value="${oi}"> <span>${o}</span>
                                </label>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="checkModule(${idx})">Submit Module Quiz</button>
            </div>
        `;
    }

    function checkModule(idx) {
        const mod = courseData.modules[idx];
        let score = 0;
        let answeredAll = true;

        mod.quiz.forEach((q, i) => {
            const sel = document.querySelector(`input[name="mq-${i}"]:checked`);
            if(!sel) answeredAll = false;
            else if(parseInt(sel.value) === q.ans) score++;
        });

        if(!answeredAll) { alert("Please answer all questions."); return; }

        const passing = Math.ceil(mod.quiz.length * 0.75);
        if(score >= passing) {
            alert(`Passed! Score: ${score}/${mod.quiz.length}. Proceeding.`);
            renderModule(idx + 1);
        } else {
            alert(`Failed. Score: ${score}/${mod.quiz.length}. You need ${passing} to pass. Please retry.`);
        }
    }

    function renderPosttest() {
        app.innerHTML = `
            <div class="card">
                <h2>Post-Test (AI Evaluated)</h2>
                <div class="instruction-box">
                    <strong>Instructions:</strong> Achieve a 90% passing rate.
                </div>
                
                <h3>Test I. Matching Type</h3>
                ${['Service Standards', 'Vision/Mission', 'Redress Mechanism', 'Checklist of Requirements', 'Flowchart'].map((item, i) => `
                    <div class="quiz-item">
                        <label><strong>${i+1}. ${item}</strong></label>
                        <select id="post1-${i}" style="margin-top:5px;"><option value="">Select...</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select>
                    </div>
                `).join('')}

                <h3>Test II. True or False</h3>
                <table class="data-table">
                    <thead><tr><th>Statement</th><th>Before</th><th>After</th></tr></thead>
                    <tbody>
                        ${['Citizen’s Charter is for lawyers', 'Procedures include person responsible', 'Feedback optional', 'Specify max time', 'Only head involved'].map((txt, i) => `
                            <tr>
                                <td>${i+1}. ${txt}</td>
                                <td>${userState.pretest_part2_answers[i] || '-'}</td>
                                <td><select id="post2-${i}"><option value="">Select...</option><option value="T">T</option><option value="F">F</option></select></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <br>
                <button class="btn" onclick="checkPosttest()">Submit Post-Test</button>
            </div>
        `;
    }

    function checkPosttest() {
        let score = 0;
        const p1Key = ['C','D','A','B','E']; 
        const p2Key = ['F','T','F','T','F'];

        for(let i=0; i<5; i++) if(document.getElementById(`post1-${i}`).value === p1Key[i]) score++;
        for(let i=0; i<5; i++) if(document.getElementById(`post2-${i}`).value === p2Key[i]) score++;

        let totalScore = score;
        
        // Simplified passing for Demo (6/10)
        if(totalScore >= 6) {
             if(userState.docId) {
                mockDB.update(userState.docId, { 
                    posttest_score: totalScore,
                    ai_engagement: aiProctor.getEngagementScore(),
                    status: 'Completed' 
                });
            }
            alert(`Passed Post-Test! Score: ${totalScore}/10. Proceeding to Evaluation.`);
            renderEvaluation();
        } else {
            alert(`Failed. Score: ${totalScore}/10. Please review.`);
        }
    }

    function renderEvaluation() {
        app.innerHTML = `
            <div class="card">
                <h2>Program Evaluation</h2>
                <form id="evalForm">
                    <p>How would you rate the training?</p>
                    <select id="rating">
                        <option value="5">5 - Excellent</option>
                        <option value="4">4 - Very Good</option>
                        <option value="3">3 - Good</option>
                    </select>
                    <button type="submit" class="btn" style="margin-top:20px;">Generate Certificate</button>
                </form>
            </div>
        `;

        document.getElementById('evalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            renderCertificate();
        });
    }

    function renderCertificate() {
        app.innerHTML = `
            <div id="certificate-view" style="display:block">
                <div style="border: 2px solid var(--accent); padding: 30px; height: 100%; position:relative;">
                    
                    <div style="display:flex; justify-content:center; gap:50px; margin-bottom:20px;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Department_of_Transportation_%28Philippines%29.svg/1200px-Department_of_Transportation_%28Philippines%29.svg.png" style="height:100px;">
                        <img src="https://bagongpilipinasmediahub.ph/wp-content/uploads/2023/12/bagong-pilipinas-logo.png" style="height:100px;">
                    </div>

                    <h1 style="color:var(--primary); font-family: 'Georgia', serif; font-size: 3rem; margin:10px 0;">CERTIFICATE OF COMPLETION</h1>
                    
                    <p style="font-size:1.3rem; margin-top:20px;">is proudly presented to</p>
                    <div style="font-size:2.5rem; font-weight:bold; border-bottom:3px solid var(--accent); display:inline-block; min-width:500px; margin:20px 0; text-transform:uppercase;">
                        ${userState.info.name}
                    </div>
                    
                    <div style="font-size:1.2rem; line-height:1.6; margin: 20px 10%;">
                        For successfully completing the interactive self-paced online learning course entitled:<br>
                        <strong style="font-size:1.5rem; color:#222;">"Service Excellence: A Guide to RA11032 Citizen's Charter"</strong><br>
                        
                        <div style="margin:20px 0;">
                            <span style="display:inline-block; padding:10px 20px; background:#f0f4ff; border:2px solid var(--primary); border-radius:50px; color:var(--primary); font-weight:bold; font-size:1.1rem;">
                                CREDITED: 4 TRAINING HOURS
                            </span>
                        </div>

                        Given this ${new Date().toLocaleDateString()}.
                    </div>
                    
                    <div style="margin: 30px 0; font-size:1rem; color:#555;">
                        <strong>COMPETENCY COMPLETED</strong><br>
                        Core Competency | Basic Level | Quality Management
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:50px; padding:0 50px;">
                        <div id="qrcode"></div>
                        <div style="text-align:center;">
                            <div style="border-top: 2px solid #333; width: 350px; margin-bottom:10px;"></div>
                            <strong>ERIKA LLYSSA G. MAGPAYO</strong><br>
                            <span style="font-size:0.9rem;">Director IV for Administrative Service concurrent<br>
                            Management Information Systems Service</span>
                        </div>
                    </div>
                    
                    <p style="font-size:0.7rem; margin-top:30px; color:#999">Certificate ID: CERT-${userState.docId}</p>
                </div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn" onclick="window.print()">Print Certificate</button>
                    <button class="btn" style="background:var(--error)" onclick="location.reload()">Reset</button>
                </div>
            </div>
        `;
        
        // Generate QRCode
        new QRCode(document.getElementById("qrcode"), { 
            text: `CERT-${userState.docId}|Name:${userState.info.name}|Hours:4|Date:${new Date().toLocaleDateString()}`, 
            width:120, height:120 
        });
    }

    // --- ADMIN LOGIC (OFFLINE) ---
    function verifyAdmin() {
        if(document.getElementById('admin-pass').value === 'hrdd2O26') {
            document.getElementById('login-modal').style.display='none';
            document.getElementById('app').style.display='none';
            document.getElementById('admin-panel').style.display='block';
            loadAdminData();
        } else {
            alert("Incorrect Password");
        }
    }

    async function loadAdminData() {
        const snap = await mockDB.getAll();
        let html = '';
        let total = 0, engSum = 0, completed = 0;
        
        snap.forEach(d => {
            total++;
            if(d.ai_engagement) engSum += d.ai_engagement;
            if(d.status === 'Completed') completed++;
            
            let badgeClass = 'ai-med';
            if(d.ai_engagement >= 80) badgeClass = 'ai-high';
            if(d.ai_engagement < 50) badgeClass = 'ai-low';

            html += `<tr>
                <td>${d.name}</td>
                <td>${d.pretest_score || '-'}</td>
                <td>${d.posttest_score || '-'}</td>
                <td><span class="ai-badge ${badgeClass}">${d.ai_engagement || 0}%</span></td>
                <td>${d.status}</td>
            </tr>`;
        });

        document.getElementById('admin-table').querySelector('tbody').innerHTML = html;
        document.getElementById('total-trainees').innerText = total;
        document.getElementById('avg-engagement').innerText = total ? Math.round(engSum/total) + '%' : '0%';
        document.getElementById('completion-rate').innerText = total ? Math.round((completed/total)*100) + '%' : '0%';
    }

    // Start App
    renderAttendance();
</script>
</body>
</html>